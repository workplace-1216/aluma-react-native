apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"

// Conditionally apply Google Services plugin only if google-services.json exists
def googleServicesFile = file("google-services.json")
if (googleServicesFile.exists()) {
    apply plugin: 'com.google.gms.google-services'
}

react {
    autolinkLibrariesWithApp()
    debuggableVariants = ["playDebug", "amazonDebug"]
}

def enableProguardInReleaseBuilds = false
def jscFlavor = 'io.github.react-native-community:jsc-android:2026004.+'

android {
    ndkVersion rootProject.ext.ndkVersion
    buildToolsVersion rootProject.ext.buildToolsVersion
    compileSdk rootProject.ext.compileSdkVersion

    namespace "com.alumabreath.app"

    defaultConfig {
        applicationId "com.alumabreath.app"
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 11
        versionName "1.0.9"
        missingDimensionStrategy "store", "play"
    }

    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
        release {
            if (project.hasProperty('MYAPP_RELEASE_STORE_FILE')) {
                storeFile file(MYAPP_RELEASE_STORE_FILE)
                storePassword MYAPP_RELEASE_STORE_PASSWORD
                keyAlias MYAPP_RELEASE_KEY_ALIAS
                keyPassword MYAPP_RELEASE_KEY_PASSWORD
            }
        }
    }

    flavorDimensions "store"

    productFlavors {
        play { dimension "store" }
        amazon { dimension "store" }
    }

    buildTypes {
        debug { signingConfig signingConfigs.debug }
        release {
            signingConfig signingConfigs.release
            minifyEnabled enableProguardInReleaseBuilds
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
        }
    }

    /**
     * GOOGLE PLAY 16 KB PAGE SIZE FIX
     * AGP 8.5.2+ automatically aligns uncompressed native libraries to 16 KB boundaries
     * Updated react-native-mmkv to 4.0.1 which should support 16 KB pages
     */
    packaging {
        jniLibs {
            useLegacyPackaging = false  // Uncompressed - AGP 8.5.2+ auto-aligns to 16 KB
        }
        resources {
            excludes += [
                'META-INF/DEPENDENCIES',
                'META-INF/LICENSE',
                'META-INF/LICENSE.txt',
                'META-INF/license.txt',
                'META-INF/NOTICE',
                'META-INF/NOTICE.txt',
                'META-INF/notice.txt',
                'META-INF/ASL2.0',
                'META-INF/*.kotlin_module'
            ]
        }
    }
}

// Force Billing library >= 6.1.0 (RN-IAP compatible)
configurations.all {
    resolutionStrategy.force 'com.android.billingclient:billing:6.1.0'
}

dependencies {
    implementation("com.facebook.react:react-android")

    if (hermesEnabled.toBoolean()) {
        implementation("com.facebook.react:hermes-android")
    } else {
        implementation jscFlavor
    }
}

afterEvaluate {
    def installPlayDebugTask = tasks.findByName("installPlayDebug")
    if (installPlayDebugTask) {
        def installDebugTask = tasks.maybeCreate("installDebug")
        installDebugTask.dependsOn(installPlayDebugTask)
        installDebugTask.group = "install"
        installDebugTask.description = "Installs the Debug build (defaults to playDebug variant)"
    }
}
